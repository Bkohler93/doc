<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Diagnostics: Tracing, Logging and Metrics | Npgsql Documentation </title>
    <meta name="viewport" content="width=device-width">
    <meta name="title" content="Diagnostics: Tracing, Logging and Metrics | Npgsql Documentation ">
    <meta name="generator" content="docfx 2.58.9.0">
    
    <link rel="shortcut icon" href="../img/favicon.ico">
    <link rel="stylesheet" href="../styles/docfx.vendor.css">
    <link rel="stylesheet" href="../styles/docfx.css">
    <link rel="stylesheet" href="../styles/main.css">
    <meta property="docfx:navrel" content="../toc.html">
    <meta property="docfx:tocrel" content="toc.html">
    
    <meta property="docfx:rel" content="../">
    
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>
        
        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              
              <a class="navbar-brand" href="../index.html">
                <img id="logo" class="svg" src="../img/logo.svg" alt="">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>
        
        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">
        
        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">
        
        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="diagnostics-tracing-logging-and-metrics">Diagnostics: Tracing, Logging and Metrics</h1>

<p>Npgsql provides several ways to analyze what&#39;s going on inside Npgsql and to diagnose performance issues:</p>
<ul>
<li><strong>Tracing</strong> allows collecting information on which queries are executed, including precise timing information on start, end and duration. These events can be collected in a database, searched, graphically explored and otherwise analyzed.</li>
<li><strong>Logging</strong> generates textual information on various events within Npgsql; log levels can be adjusted to collect low-level information, helpful for diagnosing errors.</li>
<li><strong>Metrics</strong> generates aggregated quantitative data, useful for tracking the performance of your application in realtime and over time (e.g. how many queries are currently being executed in a particular moment).</li>
</ul>
<h2 id="tracing-with-opentelemetry-experimental">Tracing with OpenTelemetry (experimental)</h2>
<div class="NOTE"><h5>Note</h5><p>Support for tracing via OpenTelemetry has been introduced in Npgsql 6.0.</p>
<p><a href="https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/trace/semantic_conventions/database.md">The OpenTelemetry specifications for database tracing</a> are currently experimental, so Npgsql&#39;s support may change in upcoming releases.</p>
</div>
<p><a href="https://opentelemetry.io/">OpenTelemetry</a> is a widely-adopted framework for distributed observability across many languages and components; its tracing standards allow applications and libraries to emit information on activities and events, which can be exported by the application, stored and analyzed. Activities typically have start and end times, and can encompass other activities recursively; this allows you to analyze e.g. exactly how much time was spent in the database when handling a certain HTTP call.</p>
<p>To make Npgsql emit tracing data, reference the <a href="https://www.nuget.org/packages/Npgsql.OpenTelemetry">Npgsql.OpenTelemetry</a> NuGet package from your application, and set up tracing as follows:</p>
<pre><code class="lang-c#">using var tracerProvider = Sdk.CreateTracerProviderBuilder()
    .SetResourceBuilder(ResourceBuilder.CreateDefault().AddService(&quot;npgsql-tester&quot;))
    .SetSampler(new AlwaysOnSampler())
    // This optional activates tracing for your application, if you trace your own activities:
    .AddSource(&quot;MyApp&quot;)
    // This activates up Npgsql&#39;s tracing:
    .AddNpgsql()
    // This prints tracing data to the console:
    .AddConsoleExporter()
    .Build();
</code></pre><p>Once this is done, you should start seeing Npgsql trace data appearing in your application&#39;s console. At this point, you can look into exporting your trace data to a more useful destination: systems such as <a href="https://zipkin.io/">Zipkin</a> or <a href="https://www.jaegertracing.io/">Jaeger</a> can efficiently collect and store your data, and provide user interfaces for querying and exploring it. Setting these up in your application is quite easy - simply replace the console exporter with the appropriate exporter for the chosen system.</p>
<p>For example, Zipkin visualizes traces in the following way:</p>
<p><img src="/img/zipkin.png" alt="Zipkin UI Sample"></p>
<p>In this trace, the Npgsql query (to database testdb) took around 800ms, and was nested inside the application&#39;s <code>work1</code> activity, which also had another unrelated <code>subtask1</code>. This allows understanding the relationships between the different activities, and where time is being spent.</p>
<h2 id="logging">Logging</h2>
<p>Npgsql includes a built-in feature for outputting logging events which can help debug issues.</p>
<p>Npgsql logging is disabled by default and must be turned on. Logging can be turned on by setting <code>NpgsqlLogManager.Provider</code> to a class implementing the <code>INpgsqlLoggingProvider</code> interface. Npgsql comes with a console implementation which can be set up as follows:</p>
<pre><code class="lang-c#">NpgsqlLogManager.Provider = new ???
</code></pre><p><em>Note: you must set the logging provider before invoking any other Npgsql method, at the very start of your program.</em></p>
<p>It&#39;s trivial to create a logging provider that passes log messages to whatever logging framework you use, you can find such an adapter for NLog below.</p>
<p><em>Note:</em> the logging API is a first implementation and will probably improve/change - don&#39;t treat it as a stable part of the Npgsql API. Let us know if you think there are any missing messages or features!</p>
<h3 id="consoleloggingprovider">ConsoleLoggingProvider</h3>
<p>Npgsql comes with one built-in logging provider: ConsoleLoggingProvider. It will simply dump all log messages with a given level or above to stdanrd output.
You can set it up by including the following line at the beginning of your application:</p>
<pre><code class="lang-c#">NpgsqlLogManager.Provider = new ConsoleLoggingProvider(&lt;min level&gt;, &lt;print level?&gt;, &lt;print connector id?&gt;);
</code></pre><p>Level defaults to <code>NpgsqlLogLevel.Info</code> (which will only print warnings and errors).
You can also have log levels and connector IDs logged.</p>
<h3 id="statement-and-parameter-logging">Statement and Parameter Logging</h3>
<p>Npgsql will log all SQL statements at level Debug, this can help you debug exactly what&#39;s being sent to PostgreSQL.</p>
<p>By default, Npgsql will not log parameter values as these may contain sensitive information. You can turn on
parameter logging by setting <code>NpgsqlLogManager.IsParameterLoggingEnabled</code> to true.</p>
<h3 id="nlogloggingprovider-or-implementing-your-own">NLogLoggingProvider (or implementing your own)</h3>
<p>The following provider is used in the Npgsql unit tests to pass log messages to <a href="http://nlog-project.org/">NLog</a>.
You&#39;re welcome to copy-paste it into your project, or to use it as a starting point for implementing your own custom provider.</p>
<pre><code class="lang-c#">class NLogLoggingProvider : INpgsqlLoggingProvider
{
    public NpgsqlLogger CreateLogger(string name)
    {
        return new NLogLogger(name);
    }
}

class NLogLogger : NpgsqlLogger
{
    readonly Logger _log;

    internal NLogLogger(string name)
    {
        _log = LogManager.GetLogger(name);
    }

    public override bool IsEnabled(NpgsqlLogLevel level)
    {
        return _log.IsEnabled(ToNLogLogLevel(level));
    }

    public override void Log(NpgsqlLogLevel level, int connectorId, string msg, Exception exception = null)
    {
        var ev = new LogEventInfo(ToNLogLogLevel(level), &quot;&quot;, msg);
        if (exception != null)
            ev.Exception = exception;
        if (connectorId != 0)
            ev.Properties[&quot;ConnectorId&quot;] = connectorId;
        _log.Log(ev);
    }

    static LogLevel ToNLogLogLevel(NpgsqlLogLevel level)
    {
        switch (level)
        {
        case NpgsqlLogLevel.Trace:
            return LogLevel.Trace;
        case NpgsqlLogLevel.Debug:
            return LogLevel.Debug;
        case NpgsqlLogLevel.Info:
            return LogLevel.Info;
        case NpgsqlLogLevel.Warn:
            return LogLevel.Warn;
        case NpgsqlLogLevel.Error:
            return LogLevel.Error;
        case NpgsqlLogLevel.Fatal:
            return LogLevel.Fatal;
        default:
            throw new ArgumentOutOfRangeException(&quot;level&quot;);
        }
    }
}
</code></pre><h2 id="metrics-with-event-counters">Metrics with event counters</h2>
<p>Npgsql supports reporting aggregated metrics which provide snapshots on its state and activities at a given point. These can be especially useful for diagnostics issues such as connection leaks, or doing general performance analysis Metrics are reported via the standard .NET event counters feature; it&#39;s recommended to read <a href="https://devblogs.microsoft.com/dotnet/introducing-diagnostics-improvements-in-net-core-3-0/">this blog post</a> for a quick overview of how counters work.</p>
<p>To collect event counters, <a href="https://docs.microsoft.com/dotnet/core/diagnostics/dotnet-counters">install the <code>dotnet-counters</code> tool</a>. Then, find out your process PID, and run it as follows:</p>
<pre><code class="lang-output">dotnet counters monitor Npgsql -p &lt;PID&gt;
</code></pre><p><code>dotnet-counters</code> will now attach to your running process and start reporting continuous counter data:</p>
<pre><code class="lang-output">[Npgsql]
Average commands per multiplexing batch                      NaN
Average write time per multiplexing batch (us) (us)          NaN
Busy Connections                                               4
Bytes Read (Count / 1 sec)                             1,874,863
Bytes Written (Count / 1 sec)                          1,546,830
Command Rate (Count / 1 sec)                              18,199
Connection Pools                                               1
Current Commands                                               5
Failed Commands                                                0
Idle Connections                                               5
Prepared Commands Ratio (%)                                    0
Total Commands                                           372,918
</code></pre><h2 id="exceptions-errors-and-notices">Exceptions, errors and notices</h2>
<p>Most exceptions thrown by Npgsql are either of type <a class="xref" href="api/Npgsql.NpgsqlException.html">NpgsqlException</a>, or wrapped by one; this allows your application to catch <code>NpgsqlException</code> where appropriate, for all database-related errors. Note that <code>NpgsqlException</code> is a sub-class of the general <a href="https://docs.microsoft.com/dotnet/api/system.data.common.dbexception">System.Data.DbException</a>, so if your application uses more than one database type, you can catch that as well.</p>
<p>When Npgsql itself encounters an error, it typically raises that as an <code>NpgsqlException</code> directly, possibly wrapping an inner exception. For example, if a networking error occurs while communicating with PostgreSQL, Npgsql will raise an <code>NpgsqlException</code> wrapping an <code>IOException</code>; this allow you both to identify the root cause of the problem, while still identifying it as database-related.</p>
<p>In other cases, PostgreSQL itself will report an error to PostgreSQL; Npgsql raises these by throwing a <a class="xref" href="api/Npgsql.PostgresException.html">PostgresExceptions</a>, which is a sub-class of <code>NpgsqlException</code> adding important contextual information on the error. Most importantly, <code>PostgresException</code> exposes the <a class="xref" href="api/Npgsql.PostgresException.html#Npgsql_PostgresException_SqlState">SqlState</a> property, which contains the <a href="https://www.npgsql.org/doc/api/Npgsql.PostgresException.html#Npgsql_PostgresException_SqlState">PostgreSQL error code</a>. This value can be consulted to identify which error type occurred.</p>
<p>When executing multiple commands via <a class="xref" href="api/Npgsql.NpgsqlBatch.html">NpgsqlBatch</a>, the <a class="xref" href="api/Npgsql.NpgsqlException.html#Npgsql_NpgsqlException_BatchCommand">BatchCommand</a> property references the command within the batch which triggered the exception. This allows you to understand exactly what happened, and access the specific SQL which triggered the error.</p>
<p>Finally, PostgreSQL also raises &quot;notices&quot;, which contain non-critical information on command execution. Notices are not errors: they do not indicate failure and can be safely ignored, although they may contain valuable information on the execution of your commands. Npgsql exposes notices via the <a class="xref" href="api/Npgsql.NpgsqlConnection.html#Npgsql_NpgsqlConnection_Notice">Notice</a> event, which you can use to route these messages into your logging system:</p>
<pre><code class="lang-c#">conn.Notice += (_, args) =&gt; Console.WriteLine(args.Notice.MessageText);
</code></pre></article>
          </div>
          
          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/npgsql/doc/blob/main/conceptual/Npgsql/diagnostics.md/#L1" class="contribution-link">Improve this Doc</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In This Article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>
      
      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
            © Copyright 2022 The Npgsql Development Team
            
          </div>
        </div>
      </footer>
    </div>
    
    <script type="text/javascript" src="../styles/docfx.vendor.js"></script>
    <script type="text/javascript" src="../styles/docfx.js"></script>
    <script type="text/javascript" src="../styles/main.js"></script>
  </body>
</html>
